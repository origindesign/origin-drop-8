# Origin Composer template for Drupal 8 projects

This project template should provide a kickstart for managing your site
dependencies with [Composer](https://getcomposer.org/).

## Requirements

- [Git](https://git-scm.com/downloads)
- [Composer](https://getcomposer.org/download/)
- [Docker](https://docs.docker.com/engine/installation/)
- [Lando](https://lando.dev/) or  
- [Docker Compose](https://docs.docker.com/compose/install/)

This file contains two sets of instructions, one for working with Lando and the other Docker Compose. Lando is the preferred setup.

# Lando

## 1. Setting Up Origin Drop 8 for a new site

- Clone this repository into a local folder [name-of-project]
- Install dependencies with Composer

```shell
git clone git@github.com:origindesign/origin-drop-8.git [name-of-project]
cd [name-of-project]
composer install
```

Navigate to web/sites/default and rename :
```shell
settings.local.php.txt to settings.local.php
settings.php.txt to settings.php
delete settings.local.php.docker-compose.txt
```
Navigate to web/sites and rename :
```shell
development.services.yml.txt to development.services.yml
```

## 2. Preparing Pantheon

- In gitignore, comment out the lines under "Ignore directories generated by Composer" and "Ignore scaffold files"

- From the Pantheon Dashboard, create a new Drupal 8 site, ideally name this to match [name-of-project]. Then, before installing Drupal, set your site to git mode

From the root of your local project:
```shell
rm -rf .git
git init
git add -A .
git commit -m "Setting up Drupal with web docroot"
git remote add origin ssh://ID@ID.drush.in:2222/~/repository.git
git push --force origin master
```
Replace ssh://ID@ID.drush.in:2222/~/repository.git with the URL from the middle of the SSH clone URL from the Connection Info popup dialog on your dashboard.

- Once it's pushed in the repository, go back in the Pantheon Dashboard and set your site to sftp mode. Navigate to your Dev site and install Drupal using existing configuration 'Origin Drop'.
- Visit the Pantheon main dashboard and set your site back to git mode

## 4. Setting up Lando
From the root of the project rename:
````
.lando.txt to .lando.yml
````
Update .lando.yml config
- Replace [jobcode] (lines 1 and 21) with the 3 letter Origin job code for the project, this will determine your lando sites local URL: https://[jobcode].lndo.site
- Replace [pantheon-machine-name] with the Pantheon machine name for your site
- Replace [pantheon-id] with the numeric Pantheon ID. This can be retrieved from the dashboard URL

Start lando
```shell
lando start
```

## 5. Pushing to Github 
- In gitignore, uncomment the line previously commented out under "Ignore directories generated by Composer" and "Ignore scaffold files"
- Remove git files as we're no longer going to use Pantheon, but Github as host of the main repo
- Create an empty github repository with the [name-of-your-project]. This should ideally match the [pantheon-machine-name]

From the root of your local project:
```shell
rm -rf .git 
git init
git add -A .
git commit -m "Moving repo to Github"
git remote add origin git@github.com:origindesign/[name-of-your-project].git
git push -u origin master
```
- In order to use config manager, you need to sync the database from Pantheon before pushing anything else. From the root of the project:
```shell
lando pull --database=dev
```
- This way, the local and the dev site are using the same UUID so we can use config manager
- If drush fails because of permission errors, skip this and continue through the next steps to push your first commit, let circle build a new version of Drush to push to Pantheon, then revisit this step after.

## 5. Configuring Circle CI

In Circle CI, create a new project based on your Github new repo. In the environment variables enter the following:
In Circle CI, create a new project based on your Github new repo. In the environment variables enter the following:
- TERMINUS_SITE: The machine name of the Pantheon site that will be used to test your site.
- TEST_SITE_NAME: Used to set the name of the test site when installing Drupal.

These additional environment variables will be added through a context origin-pantheon-git set in /.circleci/config.yml

- TERMINUS_TOKEN: The Terminus Machine token
- GITHUB_TOKEN: Used by CircleCI to post comments on pull requests.
- ADMIN_EMAIL: Used to configure the email address to use when installing Drupal.
- ADMIN_PASSWORD: Used to set the password for the uid 1 user during site installation.
- GIT_EMAIL: Used to configure the git user’s email address for commits we make.

Then in the SSH permissions, enter your SSH key and launch a build. The build will:
- Pull the repo from github
- Build an artifact
- Create a new multidev environment on Pantheon
- Run the test set in the new environment
- If the tests pass, it will push the code to dev


# Docker Compose

## 1. Setting Up Origin Drop 8 for a new site

- Clone this repository into a local folder [name-of-project]
- Update .env to match desired [name-of-project]
- Start docker compose
- Install dependencies with Composer

```shell
git clone git@github.com:origindesign/origin-drop-8.git [name-of-project]
cd [name-of-project]
docker-compose up -d
composer install
```

Navigate to web/sites/default and rename :
```shell
settings.local.php.docker-compose.txt to settings.local.php
settings.php.txt to settings.php
delete settings.local.php.txt
```
Navigate to web/sites and rename :
```shell
development.services.yml.txt to development.services.yml
```

- Navigating to <http://[name-of-your-project].docker.localhost:8000> and install Drupal using existing configuration 'Origin Drop'
- Create .drush and .ssh folders in the container
````
docker-compose exec php sh
mkdir ~/.drush
mkdir ~/.ssh
````


## 2. Using Drush to manage Config Manager and Cache Rebuild

- Drush can be accessed normally after sshing into the php container:
```shell
docker-compose exec php sh
cd /var/www/html/web
drush status
```
- Drush can aslo be accessed through the docker-compose command and by specifiying the root directory `docker-compose exec php drush -r /var/www/html/web/ status`
- In order to simplify the command, you can create an alias in your .bashrc file like `alias ddrush='docker-compose exec php drush'` (I called mine "ddrush" for docker drush)

## 3. Preparing for Pantheon

- In gitignore, comment out the lines under "Ignore directories generated by Composer" and "Ignore scaffold files"


- From the Pantheon Dashboard, create a new Drupal 8 site; then, before installing Drupal, set your site to git mode and do the following from the root of your local project:
```shell
rm -rf .git
git init
git add -A .
git commit -m "Setting up Drupal with web docroot"
git remote add origin ssh://ID@ID.drush.in:2222/~/repository.git
git push --force origin master
```
Replace ssh://ID@ID.drush.in:2222/~/repository.git with the URL from the middle of the SSH clone URL from the Connection Info popup dialog on your dashboard.

- Once it's pushed in the repository, go back in the Pantheon Dashboard and set your site to sftp mode. Navigate to your Dev site and install drupal as normal.
- Visit the Pantheon main dashboard and set your site back to git mode
- Create a new alias file and copy the information from the Pantheon Dashboard Connection popup so you have an alias for each environment named: local, dev, test, live
- Copy the alias file from your local machine to the php container drush directory:
```shell
cd ~/.drush
docker cp [name-of-your-project].aliases.drushrc.php [name-of-your-project]_php:/root/.drush
```
- Depending on the name you set for your aliases, you should be able to run drush from your local like these:
```shell
ddrush @local status 
ddrush @dev status 
```
- Copy your ssh key into the container
````
cd ~/.ssh
docker cp id_rsa [name-of-your-project]_php:/root/.ssh
````
- You will most likley need to change the permissions of the key file, From the root of the project:
````
docker-compose exec php sh
chmod 400 ~/.ssh/id_rsa
````
- In order to use config manager, you need to sync the database and files before pushing anything else. From the root of the project:
```shell
ddrush sql-sync @local @dev
ddrush -r . rsync @local:sites/default/files/ @dev:%files
```
- This way, the local and the dev site are using the same UUID so we can use config manager
- If drush fails because of permission errors, skip this and continue through the next steps to push your first commit, let circle build a new version of Drush to push to Pantheon, then revisit this setup after.

## 4. Pushing to Github

- In gitignore, uncomment the line previously commented out under "Ignore directories generated by Composer" and "Ignore scaffold files"
- Remove git files as we're no longer going to use pantheon, but github as host of the main repo
- Create an empty github repository with the [name-of-your-project].

```shell
rm -rf .git 
git init
git add -A .
git commit -m "Moving repo to Github"
git remote add origin git@github.com:origindesign/[name-of-your-project].git
git push -u origin master
```

## 5. Configuring Circle CI

In Circle CI, create a new project based on your Github new repo. In the environment variables enter the following:
- TERMINUS_SITE: The machine name of the Pantheon site that will be used to test your site.
- TEST_SITE_NAME: Used to set the name of the test site when installing Drupal.

These additional environment variables will be added through a context origin-pantheon-git set in /.circleci/config.yml

- TERMINUS_TOKEN: The Terminus Machine token
- GITHUB_TOKEN: Used by CircleCI to post comments on pull requests.
- ADMIN_EMAIL: Used to configure the email address to use when installing Drupal.
- ADMIN_PASSWORD: Used to set the password for the uid 1 user during site installation.
- GIT_EMAIL: Used to configure the git user’s email address for commits we make.

Then in the SSH permissions, enter your SSH key and launch a build. The build will:
- Pull the repo from github
- Build an artifact
- Create a new multidev environment on Pantheon
- Run the test set in the new environment
- If the tests pass, it will push the code to dev
